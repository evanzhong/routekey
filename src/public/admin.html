<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title>Routekey</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- <link rel=" stylesheet" type="text/css" media="screen" href="main.css"> -->
		<link href="https://fonts.googleapis.com/css?family=Oxygen" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">

		<!-- CDN stuff -->
		<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
		<script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
		<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.css">
		<!-- End CDN stuff -->
		<style>
			body{
				text-align: center;
				font-family: 'Oxygen', sans-serif;
				/* background-color: #900C34;
				background-color: #800020; */
			}
			#welcome{
				font-size: 24px;
				color: darkgray;
				padding-bottom: 20px;
				border-bottom: 1px solid gainsboro;
			}
			main{
				display:flex;
				place-items:center;
				flex-direction: row;
			}
			.sides{
				width: 14vw;
				margin: auto;
				padding: 20px !important;
			}
			td{
				padding: 8px, 0px !important;
			}
			.center-main{
				margin: auto;
				text-align: center;
				width: 55vw;
				max-width: 750px;
			}
			.form-wrapper{
				background-color: #EEEEEE; 
				padding: 35px;
				padding-left: 50px;
				padding-right: 50px;
				margin-top: 35px;
				border-radius: 0.25em;
			}
			#routekey{
				font-size: 60px;
				color: dimgray;
				margin-bottom: 5px;
				margin-top: 5px;
			}
			.explanation{
				margin-top: 0px;
				font-size: 15px;
			}
			form{
				margin: 20px;
			}
			input, select{
				font-family: 'Oxygen', sans-serif;
				font-size: 15px;
				padding: 5px;
				margin-bottom: 10px;
				width: 100%;
				height: 35px;
				border-radius: 0.35em;
				border: 1px solid gainsboro;
				box-sizing: border-box;

			}
			input:focus{
				outline: none;
				box-shadow: inset 0 0 10px #C3E3FF;
				transition: 0.3s ease-in-out;
			}
			select:focus{
				outline: none;
				box-shadow: inset 0 0 10px #C3E3FF;
				transition: 0.3s ease-in-out;
			}
			button{
				cursor: pointer;
				margin-top: 10px;
				margin: auto;
				width: 100%;
				height: 50px;
				border-radius: 0.25em;
				border: 1px solid #800020;
				box-sizing: border-box;
				font-size: 25px;
				font-family: 'ubuntu';
				color: white;
				background-color: #800020;
			}
			button:focus{
				outline: none;
			}
			a:visited{
				color: blue;
			}
			/* Tachyons */
			.dim {
				opacity: 1;
				transition: opacity .15s ease-in;
			}
			.dim:hover{
				opacity: .5;
				transition: opacity .15s ease-in;
			}
			.dim:active {
				opacity: .8; transition: opacity .15s ease-out;
			}
			/* Fade in */
			.fade-in {
				opacity: 1;
				animation-name: fadeInOpacity;
				animation-iteration-count: 1;
				animation-timing-function: ease-in;
				animation-duration: 1s;
			}

			@keyframes fadeInOpacity {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			/* Generated by script */
			#notif{
				font-size: 30px;
				margin-bottom: 10px; 
			}
			#notif b{
				font-size: 35px;
				font-weight: 900;
			}
			#notif-link{
				font-size: 20px;
			}
		</style>
	</head>
	<body>
		<div class="center-main" style="min-width:850px;">
			<h3 id="welcome">RouteKey: A url shortener built for the school on Key Route</h3>
			<h1>Admin page</h1>
		</div>

		<main>
			<section class="form-wrapper fade-in sides">
				<div>Active Routekeys</div>
				<table id="sortable">
					<tbody id="grid">
					</tbody>
				</table>
			</section>
			<!-- Future TODO: Charts and tables? Current inUse? Currently inUse AdminGen true? Submit your own? -->
			<section class="form-wrapper fade-in center-main">
				<h1 id="routekey">RouteKey Admin Generation</h1>
				<p class="explanation">Generate a RouteKey with a phrase you select yourself</p>
				<form>
					<input class="url" type="url" placeholder="Paste full url: (i.e. http://blog.interviewing.io/can-fake-names-create-bias/)" required name="url" autofocus>
					<!-- Future TODO: check if phrase is url safe using: ^[a-zA-Z0-9_-]*$ -->
					<input class="phrase" type="text" placeholder="Enter a phrase, using dashes instead of spaces (i.e. bmun-waiver-2019)" required name="phrase">
					<select class="expire" list="expireTimes" required name="expire">
						<option value="10080">1 Week</option>
						<option value="20160">2 Weeks</option>
						<option value="40320">1 Month</option>
						<option value="120960">3 Months</option>
					</select>
					<button type="submit" class="submit dim">Generate!</button>
				</form>
				<section class="generated"></section>
			</section>
			<section class="form-wrapper fade-in sides">
				<p class="explanation">Have a cool word or phrase? Add it to the list-of-keys collection</p>
				<form style="margin:0px">
					<input class="new-phrase" type="text" placeholder="Enter your word or phrase" required name="phrase">
					<label for="isMorrisism">Is your word a Morrisism?</label>
					<select name="isMorrisism" id="">
						<option value="False">No</option>
						<option value="True">Yes</option>
					</select>
					<button type="submit" class="dim">Send!</button>
				</form>
			</section>
		</main>
		<a href="/">Return to home</a>
		
		<script>
		const form = document.querySelector('form');
		const result = document.querySelector('.generated');
		const table = document.querySelector('#grid');

		document.addEventListener('DOMContentLoaded', yup => {
			fetch('/load-admin-data', {
				method: 'POST',
				headers: {
					'Accept': 'application/json',
					// 'Content-Type': 'application/json'
				},
			})
			.then(response => response.json())
			.then(body => {
				table.insertAdjacentHTML('beforebegin', `
					<thead>
						<tr>
							<th>key</th>
							<th>expire time</th>
							<th>admin created</th>
						</tr>
					</thead>
				`)
				body.sort((a, b) => (a.num > b.num) ? 1 : -1)
				body.forEach((each) => {
					// console.log(each)
					table.insertAdjacentHTML('beforeend', `
						<tr>
							<td class="keys">
								<a href="${each.route}">
									${each.key}
								</a>
							</td>
							<td class="key-expire">
								${Date(each.expireAt).toString().match(/[A-Za-z]+[\s][0-9]{1,2}[\s][2][0-9]{3}/g)}
							</td>
							<td class="key-isAdminCreated">
								${each.isAdminCreated}
							</td>
						</tr>
					`)
				})
				// console.log(JSON.stringify(body));
			})
			.then(() => {
				$('#sortable').DataTable()
			})
			.catch(console.error)
		});
		form.addEventListener('submit', event => {
			event.preventDefault();
			const input = document.querySelector('.url');
			const phrase = document.querySelector('.phrase');
			const expireSelected = document.querySelector('.expire');
			fetch('/admin-route', {
				method: 'POST',
				headers: {
					'Accept': 'application/json',
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					url: input.value,
					phrase: phrase.value,
					expireTime: expireSelected.options[expireSelected.selectedIndex].value,
				})
			})
				.then(response => response.json())
				.then(body => {
					while (result.hasChildNodes()) {
						result.removeChild(result.lastChild);
					}
					console.log(JSON.stringify(body));
					if (body.key == "JXvCUuKI0dKVufgkVO2ilTRaUqM=") {
						result.insertAdjacentHTML('afterbegin', `
							<div class="generated-wrapper">
								<p id="notif">Error: That phrase is already taken</p>
								<div id="notif-link">Please select a different phrase and try again</div>
							</div>
						`);
					} else if (body.key == "syzB7EKO7c0TfEfQpnZUXrqpABc="){
						result.insertAdjacentHTML('afterbegin', `
							<div class="generated-wrapper">
								<p id="notif">Error: That phrase is already in use</p>
								<div id="notif-link">Please select a different phrase and try again</div>
							</div>
						`);
					} else {
						result.insertAdjacentHTML('afterbegin', `
						<div class="generated-wrapper">
							<p id="notif">Your RouteKey was generated: <b>${body.key}</b></p>
							<div id="notif-link">
								<span>Distribute: </span>
								<a target="_blank" class="generated-url" rel="noopener" href="/${body.key}">
									routekey.me/${body.key}
								</a>
								<span> to users </span>
							</div>
						</div>
						`);
					}
				})
				.catch(console.error)
		});
		</script>
	</body>
</html>